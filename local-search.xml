<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>jenkins_CIC部署.md</title>
    <link href="/2021/08/06/jenkins-cicd%E9%83%A8%E7%BD%B2/"/>
    <url>/2021/08/06/jenkins-cicd%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="一套基于-jenkins-的部署方法"><a href="#一套基于-jenkins-的部署方法" class="headerlink" title="一套基于 jenkins 的部署方法"></a>一套基于 jenkins 的部署方法</h1><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以我个人使用经验来说，Jenkins 使用的很痛苦。目前只是做了一套简单的方案，还有更多复杂的东西并没有做。<br>目前做到的是，本地搭建 jenkins 环境，使用 BlueOcean，Jenkins pipeline，shared library 多环境部署<br>主要精力在标准 SpringBoot 项目的部署。</p><h2 id="规范"><a href="#规范" class="headerlink" title="规范"></a>规范</h2><p>内部定义的标准的 Springboot 项目，最外层应该有一个<br>pom.xml 文件，该文件是 maven 的配置文件<br>Dockerfile 文件，Docker 容器文件<br>jenkinsfile 文件，jenkins pipeline 文件。</p><p>然后开发一个公共库，这里命名为 jenkins-pipeline-lib，并在 Jenkins 全局配置 Global Pipeline Libraries</p><p>jenkinsfile</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs groovy">library <span class="hljs-string">&#x27;relengxing-library&#x27;</span> <span class="hljs-comment">// 在Global Pipeline Libraries中配置的library name</span><br><span class="hljs-keyword">def</span> map = [:]<br><span class="hljs-comment">// 此处可以添加参数，会传入方法</span><br>build_v2(map)<br></code></pre></td></tr></table></figure><p>dockerfile<br>底层容器</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> java:<span class="hljs-number">8</span>-jdk-alpine<br><span class="hljs-keyword">RUN</span><span class="bash"> apk add --update ttf-dejavu fontconfig</span><br><span class="hljs-keyword">VOLUME</span><span class="bash"> /tmp</span><br><span class="hljs-keyword">RUN</span><span class="bash"> mkdir -p /application/agent</span><br><span class="hljs-comment"># 挂载时区</span><br><span class="hljs-keyword">ENV</span> TZ=Asia/Shanghai<br><span class="hljs-keyword">RUN</span><span class="bash"> ln -snf /usr/share/zoneinfo/<span class="hljs-variable">$TZ</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TZ</span> &gt; /etc/timezone</span><br><span class="hljs-comment">#定义jvm参数变量</span><br><span class="hljs-keyword">ENV</span> JAVA_OPTS=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-comment"># 复制SkyWalking</span><br><span class="hljs-keyword">ADD</span><span class="bash"> agent/ /application/agent/</span><br><span class="hljs-comment">#启动命令</span><br><span class="hljs-comment">#ENTRYPOINT cd /application &amp;&amp; java $&#123;JAVA_OPTS&#125; -Djava.security.egd=file:/dev/./urandom -jar app.jar</span><br></code></pre></td></tr></table></figure><p>自定义容器</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment">#FROM 192.168.1.138:5000/supay-java8-base:latest</span><br><span class="hljs-keyword">FROM</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">1.138</span>:<span class="hljs-number">5000</span>/xxxx-java8-skywalking-base:latest<br><br><span class="hljs-keyword">ARG</span> JAR_FILE<br><span class="hljs-keyword">COPY</span><span class="bash"> <span class="hljs-variable">$&#123;JAR_FILE&#125;</span> /application/app.jar</span><br><br><span class="hljs-comment">#启动命令</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> <span class="hljs-built_in">cd</span> /application &amp;&amp; java <span class="hljs-variable">$&#123;JAVA_OPTS&#125;</span> -Djava.security.egd=file:/dev/./urandom -jar app.jar</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">20002</span><br><br></code></pre></td></tr></table></figure><p>build_v2.groovy 文件<br>groovy 仅作为胶水语言，实际的编译执行等，通过 sh 和 python 来完成<br><img src="/2021/08/06/jenkins-cicd%E9%83%A8%E7%BD%B2/jenkins-project.png" alt="项目结构"><br>一些参考文章：<br><a href="https://www.jianshu.com/p/2cdc8efedf2f">Jenkins pipeline 中优雅的执行 shell/python/groovy 脚本</a></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> call(configMap) &#123;<br><br>    pipeline &#123;<br>        agent any<br>        options &#123;<br>            <span class="hljs-comment">// 禁止同时运行多个流水线</span><br>            disableConcurrentBuilds()<br>        &#125;<br>        <span class="hljs-comment">//常量参数，初始确定后一般不需更改</span><br><span class="hljs-comment">//        environment &#123;</span><br><span class="hljs-comment">//            projectName = &quot;$&#123;configMap.projectName&#125;&quot;</span><br><span class="hljs-comment">//            java_opts = &quot;$&#123;configMap.java_opts&#125;&quot;</span><br><span class="hljs-comment">//        &#125;</span><br><br>        stages &#123;<br>            stage(<span class="hljs-string">&quot;Pre work&quot;</span>) &#123;<br>                input &#123;<br>                    message <span class="hljs-string">&quot;请输入版本号?&quot;</span><br>                    ok <span class="hljs-string">&quot;确定&quot;</span><br><span class="hljs-comment">//                    submitter &quot;alice,bob&quot;</span><br>                    parameters &#123;<br>                        string(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;OLD_VERSION&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;latest&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;旧版本号?&#x27;</span>)<br>                        string(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;NEW_VERSION&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;latest&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;新版本号?&#x27;</span>)<br>                    &#125;<br>                &#125;<br><br>                steps &#123;<br>                    echo <span class="hljs-string">&quot;Pre work echo&quot;</span><br>                    dir(<span class="hljs-string">&quot;cicddir&quot;</span>) &#123;<br>                        git <span class="hljs-attr">credentialsId:</span> <span class="hljs-string">&#x27;bf518420-f0a5-4259-89a3-229462e5bdce&#x27;</span>, <span class="hljs-attr">url:</span> <span class="hljs-string">&#x27;https://gitee.com/superpay/jenkins-pipeline-lib.git&#x27;</span><br>                        sh(<span class="hljs-string">&quot;chmod -R +x ./cicd/*&quot;</span>)<br><span class="hljs-comment">//                        sh(&quot;cicd/pre.sh&quot;)</span><br>                        sh(<span class="hljs-string">&quot;python3 cicd/read_project_info.py $&#123;env.BRANCH_NAME&#125; $&#123;OLD_VERSION&#125; $&#123;NEW_VERSION&#125;&quot;</span>)<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            stage(<span class="hljs-string">&#x27;Docker Build&#x27;</span>) &#123;<br>                steps &#123;<br>                    script &#123;<br>                        dir(<span class="hljs-string">&quot;cicddir&quot;</span>) &#123;<br>                            sh(<span class="hljs-string">&quot;python3 cicd/build.py&quot;</span>)<br>                        &#125;<br>                        echo <span class="hljs-string">&quot;Docker镜像 编译完成&quot;</span><br>                    &#125;<br><br>                &#125;<br>            &#125;<br><br>            stage(<span class="hljs-string">&quot;Deploy&quot;</span>) &#123;<br>                steps &#123;<br>                    script &#123;<br>                        dir(<span class="hljs-string">&quot;cicddir&quot;</span>) &#123;<br>                            sh(<span class="hljs-string">&quot;python3 cicd/deploy.py&quot;</span>)<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        post &#123;<br>            always &#123;<br>                echo <span class="hljs-string">&#x27;I will always say Hello!&#x27;</span><br>            &#125;<br>            aborted &#123;<br>                echo <span class="hljs-string">&#x27;I was aborted&#x27;</span><br>            &#125;<br>            failure &#123;<br>                echo <span class="hljs-string">&#x27;I was failure&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>read_project_info.py 会从 pom 文件中读取项目名称等信息，从 dockerfile 读端口号, 从全局配置中读取配置信息，生成一个本地文件，供后面的脚本使用<br>build.py 执行编译命令，并推送镜像到服务器<br>deploy.py 执行部署命令，可部署到普通 docker 服务器和 K8s 服务器</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>kubernetes kubeadm 安装.md</title>
    <link href="/2021/06/06/kubernetes%20kubeadm%20%E5%AE%89%E8%A3%85/"/>
    <url>/2021/06/06/kubernetes%20kubeadm%20%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h1 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h1><table><thead><tr><th>IP 地址</th><th>主机名</th><th>角色</th><th>说明</th></tr></thead><tbody><tr><td>192.168.1.39</td><td>k8s-master-lb, k8s-master-lb.jz-sz.com</td><td>负载均衡</td><td>虚拟IP</td></tr><tr><td>192.168.1.40</td><td>k8s-master01, k8s-master01.jz-sz.com</td><td>master</td><td>master 节点</td></tr><tr><td>192.168.1.41</td><td>k8s-master02, k8s-master02.jz-sz.com</td><td>master</td><td>master 节点</td></tr><tr><td>192.168.1.42</td><td>k8s-master03, k8s-master03.jz-sz.com</td><td>master</td><td>master 节点</td></tr><tr><td>192.168.1.46</td><td>k8s-node01, k8s-node01.jz-sz.com</td><td>node</td><td>node 节点</td></tr><tr><td>192.168.1.47</td><td>k8s-node02, k8s-node02.jz-sz.com</td><td>node</td><td>node 节点</td></tr><tr><td>192.168.1.48</td><td>k8s-node03, k8s-node03.jz-sz.com</td><td>node</td><td>node 节点</td></tr><tr><td>192.168.1.49</td><td>k8s-node04, k8s-node04.jz-sz.com</td><td>node</td><td>node 节点</td></tr></tbody></table><h1 id="调整系统参数"><a href="#调整系统参数" class="headerlink" title="调整系统参数"></a>调整系统参数</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cat</span> &gt; /etc/sysctl.d/k<span class="hljs-number">8</span>s.conf &lt;&lt; EOF<br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.ip_forward = <span class="hljs-number">1</span><br><span class="hljs-attribute">net</span>.bridge.bridge-nf-call-iptables = <span class="hljs-number">1</span><br><span class="hljs-attribute">fs</span>.may_detach_mounts = <span class="hljs-number">1</span><br><span class="hljs-attribute">vm</span>.overcommit_memory = <span class="hljs-number">1</span><br><span class="hljs-attribute">vm</span>.panic_on_oom = <span class="hljs-number">0</span><br><span class="hljs-attribute">fs</span>.inotify.max_user_watches = <span class="hljs-number">89100</span><br><span class="hljs-attribute">fs</span>.file-max=<span class="hljs-number">52706963</span><br><span class="hljs-attribute">fs</span>.nr_open = <span class="hljs-number">52706963</span><br><span class="hljs-attribute">net</span>.netfilter.nf_conntrack_max=<span class="hljs-number">2310720</span><br><br><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_keepalive_time = <span class="hljs-number">600</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_keepalive_probes = <span class="hljs-number">3</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_keepalive_intvl = <span class="hljs-number">15</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_max_tw_buckets = <span class="hljs-number">36000</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_tw_reuse = <span class="hljs-number">1</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_max_orphans = <span class="hljs-number">327680</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_orphans_retries = <span class="hljs-number">3</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_syncookies = <span class="hljs-number">1</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_max_syn_backlog = <span class="hljs-number">16384</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_conntrack_max = <span class="hljs-number">65536</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_max_syn_backlog = <span class="hljs-number">16384</span><br><span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_timestamps = <span class="hljs-number">0</span><br><span class="hljs-attribute">net</span>.core.somaxconn = <span class="hljs-number">16384</span><br><span class="hljs-attribute">EOF</span><br><span class="hljs-comment"># 立即生效</span><br><span class="hljs-attribute">sysctl</span> --system<br></code></pre></td></tr></table></figure><h1 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">yum install -y yum-utils<br>yum-config-manager --add-repo http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/</span>docker-ce.repo<br>yum makecache fast<br>yum list docker-ce --showduplicates<br>yum install -y docker-ce-<span class="hljs-number">18.09</span>.<span class="hljs-number">9</span>-<span class="hljs-number">3</span>.el7 docker-ce-cli-<span class="hljs-number">18.09</span>.<span class="hljs-number">9</span>-<span class="hljs-number">3</span>.el7<br>systemctl enable --now docker<br>cat &gt; <span class="hljs-regexp">/etc/</span>docker/daemon.json &lt;&lt;EOF<br>&#123;<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>],<br>  <span class="hljs-string">&quot;insecure-registries&quot;</span>: [<span class="hljs-string">&quot;192.168.1.138:5000&quot;</span>],<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>    <span class="hljs-string">&quot;https://3laho3y3.mirror.aliyuncs.com&quot;</span><br>   ],<br>  <span class="hljs-string">&quot;log-driver&quot;</span>: <span class="hljs-string">&quot;json-file&quot;</span>,<br>  <span class="hljs-string">&quot;log-opts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;max-size&quot;</span>: <span class="hljs-string">&quot;100m&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;storage-driver&quot;</span>: <span class="hljs-string">&quot;overlay2&quot;</span><br>&#125;<br>EOF<br>systemctl restart docker<br><span class="hljs-comment"># 测试</span><br>docker run hello-world<br></code></pre></td></tr></table></figure><h1 id="安装基础组件"><a href="#安装基础组件" class="headerlink" title="安装基础组件"></a>安装基础组件</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/etc/yum</span>.repos.d/kubernetes.repo<br>cat &lt;&lt; <span class="hljs-string">&#x27;EOF&#x27;</span> &gt; <span class="hljs-regexp">/etc/yum</span>.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/kubernetes/yum</span><span class="hljs-regexp">/repos/</span>kubernetes-el7-x86_64/<br>enable=<span class="hljs-number">1</span><br>gpgcheck=<span class="hljs-number">1</span><br>repo_gpgcheck=<span class="hljs-number">1</span><br>gpgkey=https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/kubernetes/yum</span><span class="hljs-regexp">/doc/yum</span>-key.gpg<br>              https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/kubernetes/yum</span><span class="hljs-regexp">/doc/</span>rpm-package-key.gpg<br>EOF<br><br><br>yum list kubeadm --showduplicates<br></code></pre></td></tr></table></figure><h1 id="版本太新，阿里云镜像不支持"><a href="#版本太新，阿里云镜像不支持" class="headerlink" title="版本太新，阿里云镜像不支持"></a>版本太新，阿里云镜像不支持</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">yum</span> install -y kubelet-<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span>-<span class="hljs-number">0</span> kubeadm-<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span>-<span class="hljs-number">0</span> kubectl-<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span>-<span class="hljs-number">0</span><br><span class="hljs-attribute">systemctl</span> enable --now kubelet<br></code></pre></td></tr></table></figure><h1 id="检查初始化需要的镜像"><a href="#检查初始化需要的镜像" class="headerlink" title="检查初始化需要的镜像"></a>检查初始化需要的镜像</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kubeadm</span> config images list<br><span class="hljs-attribute">k8s</span>.gcr.io/kube-apiserver:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">k8s</span>.gcr.io/kube-controller-manager:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">k8s</span>.gcr.io/kube-scheduler:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">k8s</span>.gcr.io/kube-proxy:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">k8s</span>.gcr.io/pause:<span class="hljs-number">3</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">k8s</span>.gcr.io/etcd:<span class="hljs-number">3</span>.<span class="hljs-number">3</span>.<span class="hljs-number">15</span>-<span class="hljs-number">0</span><br><span class="hljs-attribute">k8s</span>.gcr.io/coredns:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><h1 id="使用阿里云并标记"><a href="#使用阿里云并标记" class="headerlink" title="使用阿里云并标记"></a>使用阿里云并标记</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/&#123;镜像名称&#125;:&#123;版本&#125;<br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/&#123;镜像名称&#125;:&#123;版本&#125; k<span class="hljs-number">8</span>s.gcr.io/&#123;镜像名称&#125;:&#123;版本&#125;<br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:<span class="hljs-number">3</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:<span class="hljs-number">3</span>.<span class="hljs-number">3</span>.<span class="hljs-number">15</span>-<span class="hljs-number">0</span><br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span><br><br><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span> k<span class="hljs-number">8</span>s.gcr.io/kube-apiserver:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span> k<span class="hljs-number">8</span>s.gcr.io/kube-controller-manager:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span> k<span class="hljs-number">8</span>s.gcr.io/kube-scheduler:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span> k<span class="hljs-number">8</span>s.gcr.io/kube-proxy:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:<span class="hljs-number">3</span>.<span class="hljs-number">1</span> k<span class="hljs-number">8</span>s.gcr.io/pause:<span class="hljs-number">3</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:<span class="hljs-number">3</span>.<span class="hljs-number">3</span>.<span class="hljs-number">15</span>-<span class="hljs-number">0</span> k<span class="hljs-number">8</span>s.gcr.io/etcd:<span class="hljs-number">3</span>.<span class="hljs-number">3</span>.<span class="hljs-number">15</span>-<span class="hljs-number">0</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span> k<span class="hljs-number">8</span>s.gcr.io/coredns:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span><br><br><br><span class="hljs-attribute">docker</span> pull quay.mirrors.ustc.edu.cn/coreos/flannel:v<span class="hljs-number">0</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span>-amd<span class="hljs-number">64</span><br><span class="hljs-attribute">docker</span> tag quay.mirrors.ustc.edu.cn/coreos/flannel:v<span class="hljs-number">0</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span>-amd<span class="hljs-number">64</span> quay.io/coreos/flannel:v<span class="hljs-number">0</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span>-amd<span class="hljs-number">64</span><br></code></pre></td></tr></table></figure><h1 id="初始化-master"><a href="#初始化-master" class="headerlink" title="初始化 master"></a>初始化 master</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 添加地址，方便后续高可用，阿里云或其它云请直接使用slb</span><br>ip addr <span class="hljs-builtin-name">add</span> 192.168.122.200/32 dev eth0<br><span class="hljs-comment"># 可选，生成初始化yaml</span><br>kubeadm<span class="hljs-built_in"> config </span><span class="hljs-builtin-name">print</span> init-defaults &gt; init-defaults.yaml<br>kubeadm init <span class="hljs-attribute">--kubernetes-version</span>=1.16.6 \<br>--pod-network-cidr 10.244.0.0/16 \<br>--service-cidr 172.21.0.0/20 \<br><span class="hljs-attribute">--apiserver-advertise-address</span>=0.0.0.0 \<br>--control-plane-endpoint <span class="hljs-string">&quot;192.168.122.200:6443&quot;</span> \<br>--upload-certs \<br><span class="hljs-attribute">--ignore-preflight-errors</span>=swap<br><span class="hljs-comment"># 失败重置</span><br>kubeadm reset<br>rm -rf <span class="hljs-variable">$HOME</span>/.kube/config<br><span class="hljs-comment"># 普通用户使用 kubectl </span><br>mkdir -p <span class="hljs-variable">$HOME</span>/.kube<br>sudo cp -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>sudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><span class="hljs-comment"># 也可以使用环境变量</span><br>scp k8s-master:/etc/kubernetes/admin.conf /etc/kubernetes/<br>echo <span class="hljs-string">&quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot;</span> &gt;&gt; ~/.bash_profile<br>source .bash_profile <br></code></pre></td></tr></table></figure><h1 id="配置网络，使用flannel"><a href="#配置网络，使用flannel" class="headerlink" title="配置网络，使用flannel"></a>配置网络，使用flannel</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br>wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/coreos/</span>flannel<span class="hljs-regexp">/blob/m</span>aster<span class="hljs-regexp">/Documentation/</span>kube-flannel.yml<br><span class="hljs-comment"># 替换为对应网段</span><br>net-conf.json: |<br>    &#123;<br>      <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;10.244.0.0/16&quot;</span>,<br>      <span class="hljs-string">&quot;Backend&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;Type&quot;</span>: <span class="hljs-string">&quot;vxlan&quot;</span><br>      &#125;<br>    &#125;<br>docker pull quay.mirrors.ustc.edu.cn<span class="hljs-regexp">/coreos/</span>flannel:v0.<span class="hljs-number">12.0</span>-amd64<br>docker tag quay.mirrors.ustc.edu.cn<span class="hljs-regexp">/coreos/</span>flannel:v0.<span class="hljs-number">12.0</span>-amd64 quay.io<span class="hljs-regexp">/coreos/</span>flannel:v0.<span class="hljs-number">12.0</span>-amd64<br>kubectl apply -f kube-flannel.yml<br></code></pre></td></tr></table></figure><h1 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-builtin-name">get</span> nodes<br><span class="hljs-comment"># 检查集群配置</span><br>kubectl -n kube-system <span class="hljs-builtin-name">get</span> cm kubeadm-config -o yaml<br></code></pre></td></tr></table></figure><h1 id="node-拉取镜像"><a href="#node-拉取镜像" class="headerlink" title="node 拉取镜像"></a>node 拉取镜像</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:<span class="hljs-number">3</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span><br><br><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span> k<span class="hljs-number">8</span>s.gcr.io/kube-proxy:v<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:<span class="hljs-number">3</span>.<span class="hljs-number">1</span> k<span class="hljs-number">8</span>s.gcr.io/pause:<span class="hljs-number">3</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span> k<span class="hljs-number">8</span>s.gcr.io/coredns:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span><br><br><br><span class="hljs-attribute">docker</span> pull quay.mirrors.ustc.edu.cn/coreos/flannel:v<span class="hljs-number">0</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span>-amd<span class="hljs-number">64</span><br><span class="hljs-attribute">docker</span> tag quay.mirrors.ustc.edu.cn/coreos/flannel:v<span class="hljs-number">0</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span>-amd<span class="hljs-number">64</span> quay.io/coreos/flannel:v<span class="hljs-number">0</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span>-amd<span class="hljs-number">64</span><br></code></pre></td></tr></table></figure><h1 id="加入集群"><a href="#加入集群" class="headerlink" title="加入集群"></a>加入集群</h1><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta"># 添加 master</span><br>kubeadm init phase upload-certs --upload-certs<br>kubeadm <span class="hljs-built_in">token</span> <span class="hljs-keyword">create</span> --<span class="hljs-keyword">print</span>-join-command<br><span class="hljs-meta"># 合并</span><br>kubeadm join <span class="hljs-number">192.168</span><span class="hljs-number">.122</span><span class="hljs-number">.252</span>:<span class="hljs-number">6443</span> --<span class="hljs-built_in">token</span> qmihb0<span class="hljs-number">.2</span>j6ikktkew8ch3vz     --discovery-<span class="hljs-built_in">token</span>-ca-cert-hash sha256:db586028c918052bfb1b657472a4bee3d114de93b809b5ff8b53b3b7bded665a \<br>--control-plane --certificate-<span class="hljs-built_in">key</span> <span class="hljs-number">0</span>b84889916022953e6777da8babe9b643131d104a1d7f91db1a6ae7ddc60d18b<br><span class="hljs-meta"># 添加 node</span><br>kubeadm <span class="hljs-built_in">token</span> <span class="hljs-keyword">create</span> --<span class="hljs-keyword">print</span>-join-command<br>kubeadm join <span class="hljs-number">192.168</span><span class="hljs-number">.122</span><span class="hljs-number">.252</span>:<span class="hljs-number">6443</span> --<span class="hljs-built_in">token</span> uopfdg.haazo24wvd8qxxxd \<br>    --discovery-<span class="hljs-built_in">token</span>-ca-cert-hash sha256:db586028c918052bfb1b657472a4bee3d114de93b809b5ff8b53b3b7bded665a<br><span class="hljs-meta"># 删除节点</span><br>kubectl drain NODE_ID --<span class="hljs-keyword">delete</span>-<span class="hljs-keyword">local</span>-data --force --ignore-daemonsets<br>kubectl <span class="hljs-keyword">delete</span> node NODE_ID<br>kubeadm reset<br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#  查看集群版本信息</span><br>kubectl version <span class="hljs-attribute">--short</span>=<span class="hljs-literal">true</span><br>kubectl cluster-info<br><span class="hljs-comment"># 查看所有pod 状态</span><br>kubectl <span class="hljs-builtin-name">get</span> pods <span class="hljs-attribute">--namespace</span>=kube-system<br><span class="hljs-comment"># 查看 pod 状态</span><br>kubectl describe pod kub-proxy-t64ab <span class="hljs-attribute">--namespace</span>=kube-system<br></code></pre></td></tr></table></figure><h1 id="安装-helm"><a href="#安装-helm" class="headerlink" title="安装 helm"></a>安装 helm</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">helm</span> version<br><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/kubernetes-helm/tiller:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span><br><span class="hljs-attribute">docker</span> tag quay.mirrors.ustc.edu.cn/coreos/flannel:v<span class="hljs-number">0</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span>-amd<span class="hljs-number">64</span> quay.io/coreos/flannel:v<span class="hljs-number">0</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span>-amd<span class="hljs-number">64</span><br></code></pre></td></tr></table></figure><h1 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker pull quay.mirrors.ustc.edu.cn quay 镜像错误：net<span class="hljs-regexp">/http: TLS handshake timeout ，将https:/</span><span class="hljs-regexp">/quay.mirrors.ustc.edu.cn&quot; 加入/</span>etc<span class="hljs-regexp">/docker/</span>daemon.json register-mirrors<br>cgdriver 不一致导致不能启动问题<br>cat <span class="hljs-regexp">/etc/</span>docker/daemon.json<br>cat <span class="hljs-regexp">/etc/</span>sysconfig/kubelet<br>KUBELET_EXTRA_ARGS=--cgroup-driver=systemd<br>重启 pod<br>kubectl get pod &#123;podname&#125; -n &#123;namespace&#125; -o yaml | kubectl replace --force -f -<br>kubectl <span class="hljs-keyword">delete</span> pod -n &#123;namespace&#125; &#123;podname&#125;s<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>记录一次线上宕机的问题2020_02_20.md</title>
    <link href="/2021/02/22/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E5%AE%95%E6%9C%BA%E7%9A%84%E9%97%AE%E9%A2%982020-02-20-md/"/>
    <url>/2021/02/22/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E5%AE%95%E6%9C%BA%E7%9A%84%E9%97%AE%E9%A2%982020-02-20-md/</url>
    
    <content type="html"><![CDATA[<p>今天一个核心系统宕机了，导致所有服务不可用，在自动重启后又恢复了。</p><p>下面记录整个排查过程</p><p>我们使用的环境是 docker<br>JDK 版本 1.8<br>参数是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JVM_OPTIONS&#x3D;&quot;-Xms2048M -Xmx2048M -Xss512K -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction&#x3D;68 -XX:ParallelGCThreads&#x3D;4 -XX:+CMSClassUnloadingEnabled -Xloggc:logs&#x2F;gc.log -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+PrintGCDetails&quot;</span><br><span class="line">LIMIT_MEMORY&#x3D;2.5G</span><br><span class="line">SERVICE_REPLICAS&#x3D;4</span><br></pre></td></tr></table></figure><p>新生代老年代默认比例是 1:2<br>最大内存是 2G<br>老年代是 1365M</p><p>通过 JProfiler 分析 dump 文件<br><img src="/2021/02/22/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E5%AE%95%E6%9C%BA%E7%9A%84%E9%97%AE%E9%A2%982020-02-20-md/biggestobject.png" alt="步骤"></p><p>发现有一个大对象，600 多 M</p><p>查看对象引用<br><img src="/2021/02/22/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E5%AE%95%E6%9C%BA%E7%9A%84%E9%97%AE%E9%A2%982020-02-20-md/objref.png" alt="步骤"></p><p>发现对象是来自于 MemoryCacheStore 这个类，然后可以定位到代码。</p><p>代码发现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义缓存管理器</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SecurityMemoryCacheManager cacheManager = <span class="keyword">new</span> SecurityMemoryCacheManager();</span><br><span class="line"></span><br><span class="line">-------</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityMemoryCacheManager</span> <span class="keyword">extends</span> <span class="title">SimpleCacheManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Cache <span class="title">getMissingCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcurrentMapCache(CACHE_NAME_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentMapCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(name, <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>), <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码确实发现了一个 ConcurrentHashMap</p><p>进一步分析业务逻辑，<br>发现这个 map 是第一个架构师写的用于存储 token 和权限的。<br>实际上已经没有用到了，但是陈年老代码，也没有删除。</p><p>为什么会在这个时间出现也分析了一下原因。<br>以前这个系统经常有功能要上线，一般一个星期就会发版重启一次，但是年前那段时间，没有新功能，也就没有发版，又过了一个年，导致内存占用越来越多。<br>直到 OOM。索性系统会自动恢复，没有造成巨大影响。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>多路复用IO.md</title>
    <link href="/2021/01/24/%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8IO-md/"/>
    <url>/2021/01/24/%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8IO-md/</url>
    
    <content type="html"><![CDATA[<p>多路复用的一些参考文章</p><span id="more"></span><h2 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h2><ol><li>select 用法&amp;原理详解（源码剖析）<br><a href="https://blog.csdn.net/zhougb3/article/details/79792089">https://blog.csdn.net/zhougb3/article/details/79792089</a></li><li>深入 select 多路复用内核源码加驱动实现<br><a href="https://my.oschina.net/fileoptions/blog/911091">https://my.oschina.net/fileoptions/blog/911091</a></li><li>彻底搞懂 epoll 高效运行的原理<br><a href="https://blog.csdn.net/y277an/article/details/97622206">https://blog.csdn.net/y277an/article/details/97622206</a></li></ol><h2 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h2><p>select 是通过 bitmap 来记录所有文件描述符的，所以有最大 1024 个的限制。<br>1024 是内核默认的定义，如果想突破，需要重新编译。</p><h2 id="进化路线"><a href="#进化路线" class="headerlink" title="进化路线"></a>进化路线</h2><p>select ：<br>缺点：</p><ol><li>1024 的最大值上限。</li><li>每次都需要重新构建 fdset</li><li>两次用户态和内核态的拷贝，</li><li>需要遍历整个 fdset</li></ol><p>poll：<br>使用自定义数据结构解决了 select 1024 上限的问题<br>但是还是有其他的缺点</p><p>epoll：<br>epoll 底层使用红黑树和链表<br>epoll 会在内核的内存空间开辟一个存储区，通过 epoll_ctl 设置需要监听的文件描述符。当有 socket 就绪后，会通过回调函数，把文件描述符存储到就绪队列中。<br>当用户态程序调用 epoll_wait 时，返回就绪队列。<br>解决了 select 的其他缺点。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>redis_bitmap翻车的记录.md</title>
    <link href="/2020/09/16/redis-bitmap%E7%BF%BB%E8%BD%A6%E7%9A%84%E8%AE%B0%E5%BD%95/"/>
    <url>/2020/09/16/redis-bitmap%E7%BF%BB%E8%BD%A6%E7%9A%84%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<p>今天做一个需求，广告页，要求一天仅显示一次。</p><p>数据是存在redis的，当时想着用bitmap可以节约空间，一个用户仅需要 1 bit。<br>但是实际使用中，遇到了几个坑。userId是long型的。bitmap只能用int。</p><p>这里把long hash成 int，能解决，但是有hash碰撞的风险。不过就算发生了hash碰撞也无所谓，</p><span id="more"></span><p>然后按这个方案继续。能成功，一切正常。</p><p>但是无意中去redis看的时候，这个key 的 大小有 100M。<br>只存一个用户也是100M。<br>然后我还是按不同的商户存不同的bitmap。<br>还好是在测试环境发现了，如果上了生产，就可以直接找工作了。。。</p><p>这里分析一下。</p><p>bitmap缺失可以节约空间，一个用户最多是256M,一亿个用户也是256M。</p><p>但是我们用户少啊。。用这个方案就不太合适了</p><p>然后 我们的用户Id是雪花算法Id，不是连续的，其实用bitmap也不适合</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>注解实现字段自动解密</title>
    <link href="/2020/07/10/%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E5%AD%97%E6%AE%B5%E8%87%AA%E5%8A%A8%E8%A7%A3%E5%AF%86/"/>
    <url>/2020/07/10/%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E5%AD%97%E6%AE%B5%E8%87%AA%E5%8A%A8%E8%A7%A3%E5%AF%86/</url>
    
    <content type="html"><![CDATA[<p>最近有个项目要传输密码，密码当然不能明文传输。需要前端加密，后端解密。<br>加密算法使用 RSA。</p><p>使用注解加 AOP 实现</p><span id="more"></span><p>RSA 工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.crypto.Cipher;<br><span class="hljs-keyword">import</span> java.security.*;<br><span class="hljs-keyword">import</span> java.security.spec.InvalidKeySpecException;<br><span class="hljs-keyword">import</span> java.security.spec.PKCS8EncodedKeySpec;<br><span class="hljs-keyword">import</span> java.security.spec.X509EncodedKeySpec;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> chaoli</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-07-09 10:45</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RSAUtil</span> </span>&#123;<br><br>    <span class="hljs-comment">//非对称密钥算法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String KEY_ALGORITHM = <span class="hljs-string">&quot;RSA&quot;</span>;<br>    <span class="hljs-comment">//密钥长度，在512到65536位之间，建议不要太长，否则速度很慢，生成的加密数据很长</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> KEY_SIZE = <span class="hljs-number">512</span>;<br>    <span class="hljs-comment">//字符编码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CHARSET = <span class="hljs-string">&quot;UTF-8&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成密钥对</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> KeyPair 密钥对</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> KeyPair <span class="hljs-title">getKeyPair</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">return</span> getKeyPair(<span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成密钥对</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> password 生成密钥对的密码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> KeyPair <span class="hljs-title">getKeyPair</span><span class="hljs-params">(String password)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//实例化密钥生成器</span><br>        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance(KEY_ALGORITHM);<br>        <span class="hljs-comment">//初始化密钥生成器</span><br>        <span class="hljs-keyword">if</span>(password == <span class="hljs-keyword">null</span>)&#123;<br>            keyPairGenerator.initialize(KEY_SIZE);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            SecureRandom secureRandom = SecureRandom.getInstance(<span class="hljs-string">&quot;SHA1PRNG&quot;</span>);<br>            secureRandom.setSeed(password.getBytes(CHARSET));<br>            keyPairGenerator.initialize(KEY_SIZE, secureRandom);<br>        &#125;<br>        <span class="hljs-comment">//生成密钥对</span><br>        <span class="hljs-keyword">return</span> keyPairGenerator.generateKeyPair();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取得私钥</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyPair 密钥对</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> byte[] 私钥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] getPrivateKeyBytes(KeyPair keyPair) &#123;<br>        <span class="hljs-keyword">return</span> keyPair.getPrivate().getEncoded();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取得Base64编码的私钥</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyPair 密钥对</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String Base64编码的私钥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getPrivateKey</span><span class="hljs-params">(KeyPair keyPair)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(getPrivateKeyBytes(keyPair));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取得公钥</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyPair 密钥对</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> byte[] 公钥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] getPublicKeyBytes(KeyPair keyPair) &#123;<br>        <span class="hljs-keyword">return</span> keyPair.getPublic().getEncoded();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取得Base64编码的公钥</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyPair 密钥对</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String Base64编码的公钥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getPublicKey</span><span class="hljs-params">(KeyPair keyPair)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(getPublicKeyBytes(keyPair));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 私钥加密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data       待加密数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> privateKey 私钥字节数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> byte[] 加密数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] encryptByPrivateKey(<span class="hljs-keyword">byte</span>[] data, <span class="hljs-keyword">byte</span>[] privateKey) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//实例化密钥工厂</span><br>        KeyFactory keyFactory = KeyFactory.getInstance(KEY_ALGORITHM);<br>        <span class="hljs-comment">//生成私钥</span><br>        PrivateKey key = keyFactory.generatePrivate(<span class="hljs-keyword">new</span> PKCS8EncodedKeySpec(privateKey));<br>        <span class="hljs-comment">//数据加密</span><br>        Cipher cipher = Cipher.getInstance(KEY_ALGORITHM);<br>        cipher.init(Cipher.ENCRYPT_MODE, key);<br>        <span class="hljs-keyword">return</span> cipher.doFinal(data);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 私钥加密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data       待加密数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> privateKey Base64编码的私钥</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String Base64编码的加密数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">encryptByPrivateKey</span><span class="hljs-params">(String data, String privateKey)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">byte</span>[] key = Base64.getDecoder().decode(privateKey);<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(encryptByPrivateKey(data.getBytes(CHARSET), key));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 公钥加密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data      待加密数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> publicKey 公钥字节数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> byte[] 加密数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] encryptByPublicKey(<span class="hljs-keyword">byte</span>[] data, <span class="hljs-keyword">byte</span>[] publicKey) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//实例化密钥工厂</span><br>        KeyFactory keyFactory = KeyFactory.getInstance(KEY_ALGORITHM);<br>        <span class="hljs-comment">//生成公钥</span><br>        PublicKey key = keyFactory.generatePublic(<span class="hljs-keyword">new</span> X509EncodedKeySpec(publicKey));<br>        <span class="hljs-comment">//数据加密</span><br>        Cipher cipher = Cipher.getInstance(KEY_ALGORITHM);<br>        cipher.init(Cipher.ENCRYPT_MODE, key);<br>        <span class="hljs-keyword">return</span> cipher.doFinal(data);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 公钥加密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data      待加密数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> publicKey Base64编码的公钥</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String Base64编码的加密数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">encryptByPublicKey</span><span class="hljs-params">(String data, String publicKey)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">byte</span>[] key = Base64.getDecoder().decode(publicKey);<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(encryptByPublicKey(data.getBytes(CHARSET), key));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 私钥解密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data       待解密数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> privateKey 私钥字节数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> byte[] 解密数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] decryptByPrivateKey(<span class="hljs-keyword">byte</span>[] data, <span class="hljs-keyword">byte</span>[] privateKey) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//实例化密钥工厂</span><br>        KeyFactory keyFactory = KeyFactory.getInstance(KEY_ALGORITHM);<br>        <span class="hljs-comment">//生成私钥</span><br>        PrivateKey key = keyFactory.generatePrivate(<span class="hljs-keyword">new</span> PKCS8EncodedKeySpec(privateKey));<br>        <span class="hljs-comment">//数据解密</span><br>        Cipher cipher = Cipher.getInstance(KEY_ALGORITHM);<br>        cipher.init(Cipher.DECRYPT_MODE, key);<br>        <span class="hljs-keyword">return</span> cipher.doFinal(data);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 私钥解密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data       Base64编码的待解密数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> privateKey Base64编码的私钥</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String 解密数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">decryptByPrivateKey</span><span class="hljs-params">(String data, String privateKey)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">byte</span>[] key = Base64.getDecoder().decode(privateKey);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String(decryptByPrivateKey(Base64.getDecoder().decode(data), key), CHARSET);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 公钥解密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data      待解密数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> publicKey 公钥字节数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> byte[] 解密数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] decryptByPublicKey(<span class="hljs-keyword">byte</span>[] data, <span class="hljs-keyword">byte</span>[] publicKey) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//实例化密钥工厂</span><br>        KeyFactory keyFactory = KeyFactory.getInstance(KEY_ALGORITHM);<br>        <span class="hljs-comment">//产生公钥</span><br>        PublicKey key = keyFactory.generatePublic(<span class="hljs-keyword">new</span> X509EncodedKeySpec(publicKey));<br>        <span class="hljs-comment">//数据解密</span><br>        Cipher cipher = Cipher.getInstance(KEY_ALGORITHM);<br>        cipher.init(Cipher.DECRYPT_MODE, key);<br>        <span class="hljs-keyword">return</span> cipher.doFinal(data);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 公钥解密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data      Base64编码的待解密数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> publicKey Base64编码的公钥</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String 解密数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">decryptByPublicKey</span><span class="hljs-params">(String data, String publicKey)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">byte</span>[] key = Base64.getDecoder().decode(publicKey);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String(decryptByPublicKey(Base64.getDecoder().decode(data), key), CHARSET);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试加解密方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>       <span class="hljs-comment">//生成密钥对，一般生成之后可以放到配置文件中</span><br>       KeyPair keyPair = RSAUtil.getKeyPair();<br>       <span class="hljs-comment">//公钥</span><br>       String publicKey = RSAUtil.getPublicKey(keyPair);<br>       <span class="hljs-comment">//私钥</span><br>       String privateKey = RSAUtil.getPrivateKey(keyPair);<br><br>        System.out.println(<span class="hljs-string">&quot;公钥：\n&quot;</span> + publicKey);<br>        System.out.println(<span class="hljs-string">&quot;私钥：\n&quot;</span> + privateKey);<br><br>        String data = <span class="hljs-string">&quot;123321&quot;</span>;<br>        &#123;<br>            System.out.println(<span class="hljs-string">&quot;\n===========私钥加密，公钥解密==============&quot;</span>);<br>            String s1 = RSAUtil.encryptByPrivateKey(data, privateKey);<br>            System.out.println(<span class="hljs-string">&quot;加密后的数据:&quot;</span> + s1);<br>            String s2 = RSAUtil.decryptByPublicKey(s1, publicKey);<br>            System.out.println(<span class="hljs-string">&quot;解密后的数据:&quot;</span> + s2 + <span class="hljs-string">&quot;\n\n&quot;</span>);<br>        &#125;<br><br>        &#123;<br>            System.out.println(<span class="hljs-string">&quot;\n===========公钥加密，私钥解密==============&quot;</span>);<br>            String s1 = RSAUtil.encryptByPublicKey(data, publicKey);<br>            System.out.println(<span class="hljs-string">&quot;加密后的数据:&quot;</span> + s1);<br>            String s2 = RSAUtil.decryptByPrivateKey(s1, privateKey);<br>            System.out.println(<span class="hljs-string">&quot;解密后的数据:&quot;</span> + s2 + <span class="hljs-string">&quot;\n\n&quot;</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>字段注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.FIELD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RSAField &#123;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>方法注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><span class="hljs-comment">//声明此注解生命周期  使用runtime可以在运行时动态获得注解信息</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RSAMethod &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>AOP 实现。<br>代理所有加了 RSAMethod 注解的方法，遍历所有参数对象的字段，如果字段有 RSAField 注解，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EncryptDecryptAop</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;privateKey&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String privateKey;<br><br>    <span class="hljs-meta">@Pointcut(&quot;@annotation(xx.xx.xx.xx.RSAMethod)&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">annotationPointCut</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Around(&quot;annotationPointCut()&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">doProcess</span><span class="hljs-params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-comment">//捕获方法参数列表</span><br>        List&lt;Object&gt; methodArgs = <span class="hljs-keyword">this</span>.getMethodArgs(proceedingJoinPoint);<br>        <span class="hljs-comment">//循环所有参数</span><br>        <span class="hljs-keyword">for</span> (Object item : methodArgs) &#123;<br>            <span class="hljs-comment">//捕获参数类中的所有字段</span><br>            Field[] fields = item.getClass().getDeclaredFields();<br>            <span class="hljs-comment">//遍历所有字段</span><br>            <span class="hljs-keyword">for</span> (Field field : fields) &#123;<br>                <span class="hljs-comment">//若该字段被EncryptField注解,则进行加密</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != AnnotationUtils.findAnnotation(field, RSAField.class)) &#123;<br>                    String raw = <span class="hljs-keyword">null</span>;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//设置private类型允许访问</span><br>                        field.setAccessible(Boolean.TRUE);<br>                        raw = field.get(item).toString();<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (raw == <span class="hljs-keyword">null</span> || raw.isEmpty()) &#123;<br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br><span class="hljs-comment">//                    log.info(&quot;&#123;&#125;解密前&#123;&#125;&quot;, field.getName(), raw);</span><br>                    String decrypt = <span class="hljs-keyword">null</span>;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//解密</span><br>                        decrypt = RSAUtil.decryptByPrivateKey(raw, privateKey);<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        log.warn(<span class="hljs-string">&quot;RAS解密失败&#123;&#125;&quot;</span>, field.getName());<br>                        <span class="hljs-comment">// throw new ServiceException(ErrorEnums.PARAM_ERROR.getCode(), &quot;加密解密失败&quot;);</span><br>                    &#125;<br>                    field.set(item, decrypt);<br><span class="hljs-comment">//                    log.info(&quot;&#123;&#125;解密后&#123;&#125;&quot;, field.getName(), field.get(item).toString());</span><br>                    field.setAccessible(Boolean.FALSE);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> proceedingJoinPoint.proceed();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取方法请求参数</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;Object&gt; <span class="hljs-title">getMethodArgs</span><span class="hljs-params">(ProceedingJoinPoint proceedingJoinPoint)</span> </span>&#123;<br>        List&lt;Object&gt; methodArgs = Lists.newArrayList();<br>        <span class="hljs-keyword">for</span> (Object arg : proceedingJoinPoint.getArgs()) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != arg) &#123;<br>                methodArgs.add(arg);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> methodArgs;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis拦截器实现日志</title>
    <link href="/2020/06/22/mybatis%E6%8B%A6%E6%88%AA%E5%99%A8%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97/"/>
    <url>/2020/06/22/mybatis%E6%8B%A6%E6%88%AA%E5%99%A8%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97/</url>
    
    <content type="html"><![CDATA[<p>直接贴代码<br>关于事务还没测试，等以后再更新</p><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gvt.i18n.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cache.CacheKey;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.Executor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.ParameterMapping;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.ParameterMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.TypeHandlerRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.DateFormat;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chaoli</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-06-22 09:36</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;query&quot;, args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;query&quot;, args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123;MappedStatement.class, Object.class&#125;)</span></span><br><span class="line"><span class="meta">//        @Signature(type = StatementHandler.class, method = &quot;prepare&quot;, args = &#123;Connection.class, Integer.class&#125;),</span></span><br><span class="line"><span class="meta">//        @Signature(type = ParameterHandler.class, method = &quot;setParameters&quot;, args = &#123;PreparedStatement.class&#125;),</span></span><br><span class="line"><span class="meta">//        @Signature(type = ResultSetHandler.class, method = &quot;handleResultSets&quot;, args = &#123;Statement.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExamplePlugin</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateFormat DATE_FORMAT = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        MappedStatement mappedStatement = (MappedStatement) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line">        Object parameterObject = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (invocation.getArgs().length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            parameterObject = invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        Object result = invocation.proceed();</span><br><span class="line"></span><br><span class="line">        String statementId = mappedStatement.getId();</span><br><span class="line">        BoundSql boundSql = mappedStatement.getBoundSql(parameterObject);</span><br><span class="line">        Configuration configuration = mappedStatement.getConfiguration();</span><br><span class="line">        String sql = getSql(boundSql, parameterObject, configuration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">long</span> timing = end - start;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled() &amp;&amp; timing &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;执行sql耗时:&quot;</span> + timing + <span class="string">&quot; ms&quot;</span> + <span class="string">&quot; - id:&quot;</span> + statementId + <span class="string">&quot; - Sql:&quot;</span>);</span><br><span class="line">            log.info(<span class="string">&quot;   &quot;</span> + sql);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// todo: 纪录数据库</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(o, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getSql</span><span class="params">(BoundSql boundSql, Object parameterObject, Configuration configuration)</span> </span>&#123;</span><br><span class="line">        String sql = boundSql.getSql().replaceAll(<span class="string">&quot;[\\s]+&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">        TypeHandlerRegistry typeHandlerRegistry = configuration.getTypeHandlerRegistry();</span><br><span class="line">        <span class="keyword">if</span> (parameterMappings != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterMappings.size(); i++) &#123;</span><br><span class="line">                ParameterMapping parameterMapping = parameterMappings.get(i);</span><br><span class="line">                <span class="keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">                    Object value;</span><br><span class="line">                    String propertyName = parameterMapping.getProperty();</span><br><span class="line">                    <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">                        value = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameterObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        value = <span class="keyword">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">                        value = parameterObject;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        MetaObject metaObject = configuration.newMetaObject(parameterObject);</span><br><span class="line">                        value = metaObject.getValue(propertyName);</span><br><span class="line">                    &#125;</span><br><span class="line">                    sql = replacePlaceholder(sql, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">replacePlaceholder</span><span class="params">(String sql, Object propertyValue)</span> </span>&#123;</span><br><span class="line">        String result;</span><br><span class="line">        <span class="keyword">if</span> (propertyValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (propertyValue <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                result = <span class="string">&quot;&#x27;&quot;</span> + propertyValue + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyValue <span class="keyword">instanceof</span> Date) &#123;</span><br><span class="line">                result = <span class="string">&quot;&#x27;&quot;</span> + DATE_FORMAT.format(propertyValue) + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = propertyValue.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = <span class="string">&quot;null&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ExamplePlugin <span class="title">myPlugin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ExamplePlugin myPlugin = <span class="keyword">new</span> ExamplePlugin();</span><br><span class="line">        <span class="comment">//设置参数，比如阈值等，可以在配置文件中配置，这里直接写死便于测试</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        myPlugin.setProperties(properties);</span><br><span class="line">        <span class="keyword">return</span> myPlugin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>搭建elasticsearch_kibana</title>
    <link href="/2020/06/13/%E6%90%AD%E5%BB%BAelasticsearch-kibana/"/>
    <url>/2020/06/13/%E6%90%AD%E5%BB%BAelasticsearch-kibana/</url>
    
    <content type="html"><![CDATA[<p>docker network create elk<br>docker run -d –name elasticsearch –net elk -p 9200:9200 -p 9300:9300 -e “discovery.type=single-node” elasticsearch:6.5.4<br>docker run -d –name kibana –net elk -p 5601:5601 kibana:6.5.4</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>搭建docker_registry</title>
    <link href="/2020/06/12/%E6%90%AD%E5%BB%BAdocker-registry/"/>
    <url>/2020/06/12/%E6%90%AD%E5%BB%BAdocker-registry/</url>
    
    <content type="html"><![CDATA[<p><a href="https://www.cnblogs.com/gcgc/p/10489385.html">https://www.cnblogs.com/gcgc/p/10489385.html</a></p><p>docker pull registry</p><p>docker run -d -v /opt/registry:/var/lib/registry -p 5000:5000 –restart=always –name registry registry:latest</p><p>{<br>“registry-mirrors”: [ “<a href="https://pee6w651.mirror.aliyuncs.com&quot;],&quot;insecure-registries&quot;">https://pee6w651.mirror.aliyuncs.com&quot;],&quot;insecure-registries&quot;</a>: [“192.168.179.128:5000”]<br>}</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>编译安装Nginx</title>
    <link href="/2020/06/12/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Nginx/"/>
    <url>/2020/06/12/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Nginx/</url>
    
    <content type="html"><![CDATA[<p><a href="https://blog.csdn.net/dmedaa/article/details/89885889">https://blog.csdn.net/dmedaa/article/details/89885889</a></p><p>./configure –prefix=/usr/local/nginx –with-http_stub_status_module</p><p><a href="http://blog.oneapm.com/apm-tech/412.html">http://blog.oneapm.com/apm-tech/412.html</a></p><p>nginx status 详解<br>active connections – 活跃的连接数量<br>server accepts handled requests — 总共处理了 11989 个连接 , 成功创建 11989 次握手, 总共处理了 11991 个请求<br>reading — 读取客户端的连接数.<br>writing — 响应数据到客户端的数量<br>waiting — 开启 keep-alive 的情况下,这个值等于 active – (reading+writing), 意思就是 Nginx 已经处理完正在等候下一次请求指令的驻留连接.</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>keepalive_docker_nginx实践</title>
    <link href="/2020/06/12/keepalive-docker-nginx%E5%AE%9E%E8%B7%B5/"/>
    <url>/2020/06/12/keepalive-docker-nginx%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<p>我的本地环境，一台 Unbuntu 18.04 系统的物理机<br>想实践下 虚拟 ip，keepalive<br>就一台机器，所以用 docker 来实践一下。</p><span id="more"></span><p>关于虚拟 ip, 可以看下这篇文章<br><a href="https://www.gitos.org/2019/08/19/vip-ha.html">https://www.gitos.org/2019/08/19/vip-ha.html</a></p><p>关于 docker, keepalive 基本按这篇文章<br><a href="https://www.jianshu.com/p/6a8f38b8076d">https://www.jianshu.com/p/6a8f38b8076d</a></p><p>修改 dockerfile，减少重复下载环境</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:latest</span><br><span class="line"><span class="keyword">MAINTAINER</span> relengxing&lt;relengxing@outlook.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y gcc openssl-devel popt-devel</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y net-tools</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y vim</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y keepalived</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y nginx</span></span><br></pre></td></tr></table></figure><p>启动 centos 容器<br>–privileged=true 获取特权<br>/sbin/init：这个地方是实测 /bin/bash，会有权限没有。因为我还实验了下手动加虚拟 ip</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --name centos_master -itd --privileged&#x3D;true relengxing&#x2F;centos:v1 &#x2F;sbin&#x2F;init</span><br><span class="line">docker run --name centos_slave -itd --privileged&#x3D;true relengxing&#x2F;centos:v1 &#x2F;sbin&#x2F;init</span><br></pre></td></tr></table></figure><p>可以进容器查看 ip 地址</p><p>Master 节点<br><code>ifconfig</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eth0: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500</span><br><span class="line">inet 172.17.0.3 netmask 255.255.0.0 broadcast 172.17.255.255</span><br><span class="line">ether 02:42:ac:11:00:03 txqueuelen 0 (Ethernet)</span><br></pre></td></tr></table></figure><p>在容器外则通过 docker network<br>docker network ls<br>docker network inspect d8c58097a4c3</p><p>ifconfig eth0:0 172.17.0.88 netmask 255.255.0.0 up<br>ifconfig eth0:0 down</p><p>修改<code>/etc/keepalived/keepalived.conf</code>的内容</p><p>主节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     xuad@xuad.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@xuad.com</span><br><span class="line">   smtp_server mail.xuad.com</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;&#x2F;etc&#x2F;keepalived&#x2F;nginx_pid.sh&quot;   # 检查nginx状态的脚本</span><br><span class="line">    interval 2</span><br><span class="line">    weight 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER     #备份服务器上将MASTER改为BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101       #备份服务上将100改为小于100，可配置成90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.17.0.99    #有多个vip可在下面继续增加</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>备份节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     xuad@xuad.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@xuad.com</span><br><span class="line">   smtp_server mail.xuad.com</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;&#x2F;etc&#x2F;keepalived&#x2F;nginx_pid.sh&quot;   # 检查nginx状态的脚本</span><br><span class="line">    interval 2</span><br><span class="line">    weight 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP     #备份服务器上将MASTER改为BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99       #备份服务上将100改为小于100，可配置成90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.17.0.99    #有多个vip可在下面继续增加</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nginx_pid.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#检测nginx是否存活的脚本</span></span><br><span class="line">A=`ps -ef | grep nginx | grep -v grep | wc -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">  nginx</span><br><span class="line">  sleep 2</span><br><span class="line">  <span class="keyword">if</span> [ `ps -ef | grep nginx | grep -v grep | wc -l` -eq 0 ];<span class="keyword">then</span></span><br><span class="line">      <span class="comment">#killall keepalived</span></span><br><span class="line">      ps -ef|grep keepalived|grep -v grep|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|xargs <span class="built_in">kill</span> -9</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>修改 nginx 显示的页面，我就修改了这一行，标示是主机还是备份机</p><p>主节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;strong&gt;nginx  master Node&lt;&#x2F;strong&gt; HTTP server after it has been</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;strong&gt;nginx  Slave Node&lt;&#x2F;strong&gt; HTTP server after it has been</span><br></pre></td></tr></table></figure><p>然后在主机运行<br><code>curl 172.17.0.99</code><br>显示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">   &lt;strong&gt;nginx   master Node&lt;&#x2F;strong&gt; HTTP server after it has been</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>关闭主节点后<br>然后在主机运行<br><code>curl 172.17.0.99</code><br>显示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">   &lt;strong&gt;nginx   slave Node&lt;&#x2F;strong&gt; HTTP server after it has been</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>遇到一个问题没有解决</p><p>在主节点运行<br><code>nginx -s stop</code> 推出 nginx 后，没有切换到从节点，必须关闭主节点。</p><p>更新：<br>这个问题看了下<br>是 nginx 检测脚本的问题<br>修改为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 如果进程中没有nginx则将keepalived进程kill掉</span></span><br><span class="line">A=`ps -C nginx --no-header |wc -l`      <span class="comment">## 查看是否有 nginx进程 把值赋给变量A</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span>                    <span class="comment">## 如果没有进程值得为 零</span></span><br><span class="line">    systemctl stop keepalived.service           <span class="comment">## 则结束 keepalived 进程</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>成功了</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>记录：在K8S上创建高可用的MySql集群</title>
    <link href="/2019/12/14/%E8%AE%B0%E5%BD%95%EF%BC%9A%E5%9C%A8K8S%E4%B8%8A%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84MySql%E9%9B%86%E7%BE%A4/"/>
    <url>/2019/12/14/%E8%AE%B0%E5%BD%95%EF%BC%9A%E5%9C%A8K8S%E4%B8%8A%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84MySql%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="更新-2"><a href="#更新-2" class="headerlink" title="更新 2"></a>更新 2</h2><span id="more"></span><p>查看了 kubernetes 的资料和配置<br>Pod CIDR 10.9.12.0/24<br>Pod CIDR 10.9.13.0/24<br>Pod CIDR 10.10.11.0/24</p><p>这里不连续的原因是， Mysql-0 和 Mysql-1 使用的两台机器是常年开着的，没有关闭过<br>而 Mysql-2 使用的机器是刚刚创建的，而我们的集群有个特点，就是频繁的创建和删除节点。 这里猜测 kubernetes 在分配 ip 的时候是顺序分配的,如果分配完了再从头开始分配，把已经释放的重新分配。</p><p>由于我们使用的是 Google kubernetes，很多东西是无法更改的。<br>所以解决方案我认为有：</p><ol><li>重新创建一个 nodepool,把 mysql 部署在这个新创建的 nodepool 上，这样新的机器大概率 IP 连续。</li><li>修改 kubedb 的源码，把白名单的子网掩码修改为/8。其实我觉得这里作者的代码应该优化一下，使用 service 的方式来寻找 pod，而不是通过 Pod IP。</li><li>寻找其他 MySql 高可用部署的解决方案</li></ol><p>我准备就创建一个 nodepool，因为从我的个人实际情况出发，这是最简单有效，最快速的解决方案，然后问题也和提了 issue，希望作者会进行优化。</p><h2 id="更新-1"><a href="#更新-1" class="headerlink" title="更新 1"></a>更新 1</h2><p>问题查了下，看了下作者的更新记录<br><a href="https://github.com/kubedb/mysql/commit/1db0fa511d31f32bf36b4dcdc07733d3853f3d18">https://github.com/kubedb/mysql/commit/1db0fa511d31f32bf36b4dcdc07733d3853f3d18</a><br>关键的几行</p><!--more--><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myips&#x3D;$(hostname -I)</span><br><span class="line">first&#x3D;$&#123;myips%% *&#125;</span><br><span class="line"># Now use this IP with CIDR notation</span><br><span class="line">export whitelist&#x3D;&quot;$&#123;first&#125;&#x2F;16&quot;</span><br></pre></td></tr></table></figure><p>然后我确认了下我的 IP：<br>mysql-0:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IP:                 10.9.12.246</span><br></pre></td></tr></table></figure><p>mysql-2:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IP:                 10.10.11.2</span><br></pre></td></tr></table></figure><p>这里 kubernetes 内网 IP 的第二个数不一样，作者的掩码是/16，我这里需要/8<br>我觉得这个问题应该在 kubernetes 这里找解决方案</p><h2 id="原文"><a href="#原文" class="headerlink" title="原文"></a>原文</h2><p>参考文章：<br><a href="https://jeremy-xu.oschina.io/2019/08/kubernetes%E4%B8%AD%E9%83%A8%E7%BD%B2mysql%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/">https://jeremy-xu.oschina.io/2019/08/kubernetes%E4%B8%AD%E9%83%A8%E7%BD%B2mysql%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/</a><br><a href="https://kubedb.com/docs/0.12.0/guides/mysql/clustering/overview/">https://kubedb.com/docs/0.12.0/guides/mysql/clustering/overview/</a></p><p>按照博主的文章，确实搭建成功了。但是在后续改进的时候遇到了问题，目前还没有解决，先记录下来，以后解决了再修改。</p><!--more--><p>我使用的是 google 的 kubernetes,这里使用的是一台四核的机器，三个节点全部部署在同一台机器上，上面还有一些其他的服务，基本上单节点分配不到一个核。<br>在另一台单核的 VM 上使用 sysbench 进行测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysbench &#x2F;usr&#x2F;share&#x2F;sysbench&#x2F;oltp_read_write.lua --time&#x3D;180 --mysql-host&#x3D;mysqlip --mysql-port&#x3D;3306 --mysql-user&#x3D;root --mysql-password&#x3D;mysqlmima --mysql-db&#x3D;demo --table-size&#x3D;50000 --tables&#x3D;8 --threads&#x3D;8 prepare</span><br><span class="line"></span><br><span class="line">sysbench &#x2F;usr&#x2F;share&#x2F;sysbench&#x2F;oltp_read_write.lua --time&#x3D;180 --mysql-host&#x3D;mysqlip --mysql-port&#x3D;3306 --mysql-user&#x3D;root --mysql-password&#x3D;mysqlmima --mysql-db&#x3D;demo --table-size&#x3D;50000 --tables&#x3D;8 --threads&#x3D;8 run &gt;&gt; k8smysql.log</span><br></pre></td></tr></table></figure><p>第一次直接挂了，改小数据量后重新测试得到测试报告</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">sysbench 1.0.19 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">Running the test with following options:</span><br><span class="line">Number of threads: 8</span><br><span class="line">Initializing random number generator from current time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Threads started!</span><br><span class="line"></span><br><span class="line">FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#39;SELECT c FROM sbtest7 WHERE id&#x3D;?&#39;</span><br><span class="line">FATAL: &#96;thread_run&#39; function failed: &#x2F;usr&#x2F;share&#x2F;sysbench&#x2F;oltp_common.lua:419: SQL error, errno &#x3D; 2013, state &#x3D; &#39;HY000&#39;: Lost connection to MySQL server during query</span><br><span class="line">sysbench 1.0.19 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">Running the test with following options:</span><br><span class="line">Number of threads: 8</span><br><span class="line">Initializing random number generator from current time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Threads started!</span><br><span class="line"></span><br><span class="line">SQL statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        read:                            310646</span><br><span class="line">        write:                           68981</span><br><span class="line">        other:                           64143</span><br><span class="line">        total:                           443770</span><br><span class="line">    transactions:                        22187  (123.19 per sec.)</span><br><span class="line">    queries:                             443770 (2463.94 per sec.)</span><br><span class="line">    ignored errors:                      2      (0.01 per sec.)</span><br><span class="line">    reconnects:                          0      (0.00 per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          180.1038s</span><br><span class="line">    total number of events:              22187</span><br><span class="line"></span><br><span class="line">Latency (ms):</span><br><span class="line">         min:                                   22.81</span><br><span class="line">         avg:                                   64.91</span><br><span class="line">         max:                                  370.94</span><br><span class="line">         95th percentile:                      139.85</span><br><span class="line">         sum:                              1440248.80</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg&#x2F;stddev):           2773.3750&#x2F;1495.23</span><br><span class="line">    execution time (avg&#x2F;stddev):   180.0311&#x2F;0.04</span><br></pre></td></tr></table></figure><p>说实话性能一般，所以准备使用更好的机器继续测试性能，让单个节点使用两个核。</p><p>这一步的时候出问题了，集群起不来。<br>查了一下，发现有人也遇到了同样的问题，作者说解决了，但是我今天实测还是出了这个问题。<br><a href="https://github.com/kubedb/project/issues/529">https://github.com/kubedb/project/issues/529</a><br>目前没有找到很好的解决方案，在 github 上提了新的 issue<br><a href="https://github.com/kubedb/project/issues/702">https://github.com/kubedb/project/issues/702</a><br>希望可以得到解决。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>一致性哈希</title>
    <link href="/2019/11/14/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/"/>
    <url>/2019/11/14/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/</url>
    
    <content type="html"><![CDATA[<p>背景这块就简单说一下，一致性哈希是为了解决简单哈希带来的问题。</p><p>以 redis 分布式缓存场景为例<br>有大概一百万张图片要分在 4 台机器上，后来数据量变多了，需要增加一台机器。</p><span id="more"></span><h2 id="简单哈希"><a href="#简单哈希" class="headerlink" title="简单哈希"></a>简单哈希</h2><p>简单哈希的做法是，首先计算哈希值，然后进行取模运算<br><code>hash(图片名称) % N</code><br>那么每张图片都会对应到一台机器上，很好的解决了图片分散存储的问题。</p><p>但是，当我们需要增加一台服务器的时候就出问题了。 取模运算的结果不一样了，在对应的机器上找不到缓存，大量缓存在同一时间失效，造成了缓存的雪崩</p><p>为了解决这个问题，发明了一致性哈希算法。</p><h2 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h2><p>一致性哈希也是取模算法，但是不是对服务器数量，而是对 2^32 取模。<br>为什么是 2^32?<br>因为，java 中 int 的最大值是 2^31-1 最小值是-2^31,2^32 刚好是无符号整形的最大值；</p><p>简单来说，一致性 Hash 算法将整个哈希值空间组织成一个虚拟的圆环，假设某哈希函数 H 的值空间为 0 ～ 2^32-1（即哈希值是一个 32 位无符号整形）<br>哈希算法合理的话，图片应该是大致均匀分布在这个虚拟的圆环上。<br><code>hash(图片名称) % 2^32</code></p><p>同时服务器也需要进行哈希<br><code>hash（服务器A的IP地址） % 2^32</code></p><p>图片和服务器都哈希取模完后，就能确定此数据在环上的位置，从此位置沿环顺时针“行走”，第一台遇到的服务器就是其应该定位到的服务器</p><p>假设此时有 C 服务器发生故障，那么原 B~C 的数据会重新定位到 D 服务器，其他服务器的数据则不受影响。<br>增加一台一起也是一样，只有一部分内容会受到影响。具有较好的容错性和可扩展性。</p><h3 id="一致性哈希的其他问题及解决方案"><a href="#一致性哈希的其他问题及解决方案" class="headerlink" title="一致性哈希的其他问题及解决方案"></a>一致性哈希的其他问题及解决方案</h3><h4 id="数据倾斜问题"><a href="#数据倾斜问题" class="headerlink" title="数据倾斜问题"></a>数据倾斜问题</h4><p>数据倾斜问题指的是，当服务器进行哈希取模的时候，没有平均分配到数据环上。比如 ABCD 全都在右半区，那么 A 节点受到的压力会是最大的，其他节点受到的压力会小一些。<br>解决方案是 增加虚拟节点：<br>即 对每一个节点计算多个哈希值。<br>在实际应用中，通常将虚拟节点数设置为 32 甚至更大，因此即使很少的服务节点也能做到相对均匀的数据分布。</p><p>怎么计算出多个节点<br><code>Hash(192.168.1.1#1”);  // cache A1</code><br><code>Hash(192.168.1.1#2”);  // cache A2</code></p>]]></content>
    
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>哈希</tag>
      
      <tag>一致性哈希</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>树莓派3搭建linux服务器</title>
    <link href="/2019/10/24/%E6%A0%91%E8%8E%93%E6%B4%BE3%E6%90%AD%E5%BB%BAlinux%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <url>/2019/10/24/%E6%A0%91%E8%8E%93%E6%B4%BE3%E6%90%AD%E5%BB%BAlinux%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<p>前段时间租了三个月阿里云，感觉太贵了，就买了个树莓派 3，准备搭建一个 linux 操作系统，当服务器用用，大概花费不到 300。电源 5V×2.5A，一般情况下不用这么高的电流，功耗其实很低的。</p><span id="more"></span><p>组装就不说了。。成品如下<br><img src="/2019/10/24/%E6%A0%91%E8%8E%93%E6%B4%BE3%E6%90%AD%E5%BB%BAlinux%E6%9C%8D%E5%8A%A1%E5%99%A8/%E6%A0%91%E8%8E%93%E6%B4%BE.jpeg" alt="树莓派"><br>几个要下载的东西:<br>链接：<a href="http://pan.baidu.com/s/1o8FC0xO">http://pan.baidu.com/s/1o8FC0xO</a> 密码：psww<br>这个是系统<br><img src="/2019/10/24/%E6%A0%91%E8%8E%93%E6%B4%BE3%E6%90%AD%E5%BB%BAlinux%E6%9C%8D%E5%8A%A1%E5%99%A8/UbuntuServer.jpg" alt="系统"><br>把他解压出来是一个.img 文件。</p><p>这个软件安装一下。<br><code>Win32DiskImager-0.9.5-install.exe</code><br>内存卡，读卡器准备好</p><p>然后就写到系统里面<br><img src="/2019/10/24/%E6%A0%91%E8%8E%93%E6%B4%BE3%E6%90%AD%E5%BB%BAlinux%E6%9C%8D%E5%8A%A1%E5%99%A8/%E6%AD%A5%E9%AA%A4.jpg" alt="步骤"></p><p>写完以后就可以插到树莓派上了，网线端接路由器的 LAN 口，电脑和树莓派在同一个局域网下。<br>上电，等开好机</p><p>在路由器管理页面下可以找到<br>我的是 192.168.0.104</p><p>然后就可以用 xshell 连接了<br><img src="/2019/10/24/%E6%A0%91%E8%8E%93%E6%B4%BE3%E6%90%AD%E5%BB%BAlinux%E6%9C%8D%E5%8A%A1%E5%99%A8/Xshell%E8%BF%9E%E6%8E%A5.jpg" alt="Xshell连接"><br><img src="/2019/10/24/%E6%A0%91%E8%8E%93%E6%B4%BE3%E6%90%AD%E5%BB%BAlinux%E6%9C%8D%E5%8A%A1%E5%99%A8/%E7%99%BB%E5%BD%95.jpg" alt="登录"><br>然后就登录成功了<br>我这里是用有线连接的，无线的没有去做了<br><img src="/2019/10/24/%E6%A0%91%E8%8E%93%E6%B4%BE3%E6%90%AD%E5%BB%BAlinux%E6%9C%8D%E5%8A%A1%E5%99%A8/%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F.jpg" alt="成功"><br>OK,大功告成，然后可以开始装各种软件的开发环境了。</p>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>树莓派</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ReBus</title>
    <link href="/2017/09/08/ReBus/"/>
    <url>/2017/09/08/ReBus/</url>
    
    <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>ReBus 是一个模仿 RxBus 写的，基于 reactor3 的事件总线</p><span id="more"></span><p>RxBus 一般是 Android 端使用的，<br>ReBus 一般是后端使用的<br>RxBus 参考链接： <a href="https://github.com/relengxing/RxBus">https://github.com/relengxing/RxBus</a><br>ReBus 源码链接： <a href="https://github.com/relengxing/ReBus">https://github.com/relengxing/ReBus</a></p><p>推荐直接看 RxBus 的解析，这边只贴代码，因为思想是一模一样的，只是底层的包不一样，封装完后用法也是一样的。</p><h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><p>ReBus 代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.relenxing.config;</span><br><span class="line"><span class="keyword">import</span> com.relenxing.domain.Event;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.ReplayProcessor;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReBus</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 事件总线的核心。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReplayProcessor&lt;Event&gt; bus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数，初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ReBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bus = ReplayProcessor.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单例模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HelperHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟初始化，这里是利用了 Java 的语言特性，内部类只有在使用的时候，才会去加载，</span></span><br><span class="line"><span class="comment">     * 从而初始化内部静态变量。关于线程安全，这是 Java 运行环境自动给你保证的，</span></span><br><span class="line"><span class="comment">     * 在加载的时候，会自动隐形的同步。在访问对象的时候，</span></span><br><span class="line"><span class="comment">     * 不需要同步 Java 虚拟机又会自动给你取消同步，所以效率非常高。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelperHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> ReBus instance = <span class="keyword">new</span> ReBus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送普通事件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Event event)</span></span>&#123;</span><br><span class="line">        bus.onNext(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  Flux&lt;Event&gt; <span class="title">on</span><span class="params">(String type)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bus.filter(e -&gt; e.getEventName().equals(type));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Event 代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.relenxing.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String eventName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T event;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(String eventName, T event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.eventName = eventName;</span><br><span class="line">        <span class="keyword">this</span>.event = event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEventName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> eventName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEventName</span><span class="params">(String eventName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.eventName = eventName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEvent</span><span class="params">(T event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.event = event;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.relenxing;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       ReBus.getDefault().post(<span class="keyword">new</span> Event&lt;&gt;(<span class="string">&quot;123&quot;</span>, <span class="string">&quot;123&quot;</span>));</span><br><span class="line">       ReBus.getDefault().post(<span class="keyword">new</span> Event&lt;&gt;(<span class="string">&quot;456&quot;</span>, <span class="string">&quot;swdw&quot;</span>));</span><br><span class="line">       ReBus.getDefault().post(<span class="keyword">new</span> Event&lt;&gt;(<span class="string">&quot;123&quot;</span>, <span class="string">&quot;312&quot;</span>));</span><br><span class="line">       ReBus.getDefault().post(<span class="keyword">new</span> Event&lt;&gt;(<span class="string">&quot;456&quot;</span>, <span class="string">&quot;2f2&quot;</span>));</span><br><span class="line">       ReBus.getDefault().post(<span class="keyword">new</span> Event&lt;&gt;(<span class="string">&quot;123&quot;</span>, <span class="string">&quot;12f&quot;</span>));</span><br><span class="line"></span><br><span class="line">       ReBus.getDefault().on(<span class="string">&quot;123&quot;</span>).map(Event::getEvent).subscribe(System.out::println);</span><br><span class="line">       ReBus.getDefault().on(<span class="string">&quot;456&quot;</span>).map(Event::getEvent).subscribe(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>SpringBoot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RxBus</title>
    <link href="/2016/08/13/RxBus/"/>
    <url>/2016/08/13/RxBus/</url>
    
    <content type="html"><![CDATA[<p>参考：用 RxJava 实现事件总线(Event Bus)<br><a href="http://www.jianshu.com/p/ca090f6e2fe2">http://www.jianshu.com/p/ca090f6e2fe2</a></p><p>我这篇基本上就是按照上面那篇写的，对 Sticky 那一块进行了一些修改。<br>写下来让自己记得更深刻。这篇文章面向有 RxJava 基础的人，要是 HelloWorld 都没写过建议先看基础部分。</p><span id="more"></span><p>Git 地址：<br><a href="https://github.com/relengxing/RxBus">https://github.com/relengxing/RxBus</a></p><h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><ol><li>新建工程</li><li>添加 rxjava 和 rxandroid 依赖</li><li>完成以下界面</li></ol><p><img src="http://upload-images.jianshu.io/upload_images/2188564-7ecf70697afbb76e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="界面"></p><ol start="4"><li>编写 RxBus 文件</li><li>编写其他代码</li></ol><hr><p>RxBus 是一个全局使用的总线，应该使用单例模式。<br>单例模式的具体写法可以自己研究下。<br>参考代码：<br><a href="http://www.race604.com/java-double-checked-singleton/">http://www.race604.com/java-double-checked-singleton/</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Created by relengxing on 2016/8/12.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBus</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RxBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HelperHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelperHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RxBus instance = <span class="keyword">new</span> RxBus();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="事件总线"><a href="#事件总线" class="headerlink" title="事件总线"></a>事件总线</h3><p>那么需要一根总线来传输数据。<br>这根总线就是 RxJava 中的 Subject。</p><blockquote><p>Subject 可以看成是一个桥梁或者代理，在某些 ReactiveX 实现中（ 如 RxJava） ，<strong>它同时充当了 Observer 和 Observable 的角色</strong>。因为它是一个 Observer，它可以订阅一个或多个 Observable；又因为它是一个 Observable，它可以转发它收到(Observe)的数据，也可以发射新的数据。</p></blockquote><p>在 RxJava 中<br>针对不同的场景一共有四种类型的 Subject。</p><ul><li>AsyncSubject</li><li>BehaviorSubject</li><li>PublishSubject</li><li>ReplaySubject<br>关于这四种类型的具体说明参考：<a href="http://www.jianshu.com/p/d382c3f862d5">RxJava：Subject 介绍</a></li></ul><p>这里使用的是 PublishSubject<br>PublishSubject：只会把在订阅发生的时间点之后来自原始 Observable 的数据发射给观察者；<br>又因为线程安全的问题，需要把 PublishSubject 转化为一个线程安全的 Subject，这部分内容也在<a href="http://www.jianshu.com/p/d382c3f862d5">RxJava：Subject 介绍</a>最后一部分串行化中有介绍。<br>最后代码写成如下：</p><pre><code>private final Subject&lt;Object,Object&gt; bus;private RxBus() &#123;    bus = new SerializedSubject&lt;&gt;(PublishSubject.create());&#125;</code></pre><p>总线有了，还差事件发布者（被观察者）和事件接受者（观察者）。</p><h3 id="发送事件"><a href="#发送事件" class="headerlink" title="发送事件"></a>发送事件</h3><p>将事件 post 至 Subject，此时 Subject 作为 Observer 接收到事件（onNext），然后会发射给所有订阅该 Subject 的订阅者。<br>因为使用的是 PublishSubject，所以必须先订阅事件再发送事件才能介绍到，否则这些发送的事件会遗失。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object object)</span></span>&#123;</span><br><span class="line">    bus.onNext(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="接收事件"><a href="#接收事件" class="headerlink" title="接收事件"></a>接收事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">toObservable</span><span class="params">(Class&lt;T&gt; eventType)</span></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> bus.ofType(eventType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ofType 是 filter 操作符的一个特殊形式。它过滤一个 Observable 只返回指定类型的数据。ofType 默认不在任何特定的调度器上指定 。</p></blockquote><p>有一点需要注意的是，在接收事件的地方不需要接收事件或者生命周期结束的时候一定要取消订阅，防止内存泄漏。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!rxSubscription2.isUnsubscribed()) &#123;</span><br><span class="line">    rxSubscription2.unsubscribe();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="支持-Sticky-事件"><a href="#支持-Sticky-事件" class="headerlink" title="支持 Sticky 事件"></a>支持 Sticky 事件</h1><blockquote><p>在 Android 开发中，Sticky 事件只指事件消费者在事件发布之后才注册的也能接收到该事件的特殊类型。Android 中就有这样的实例，也就是 Sticky Broadcast，即粘性广播。正常情况下如果发送者发送了某个广播，而接收者在这个广播发送后才注册自己的 Receiver，这时接收者便无法接收到刚才的广播，为此 Android 引入了 StickyBroadcast，在广播发送结束后会保存刚刚发送的广播（Intent），这样当接收者注册完 Receiver 后就可以接收到刚才已经发布的广播。这就使得我们可以预先处理一些事件，让有消费者时再把这些事件投递给消费者。</p></blockquote><p>参考：<a href="http://www.jianshu.com/p/71ab00a2677b">深入 RxBus：［支持 Sticky 事件］</a></p><p>关于方案选择不再详述了，参考上面的链接。<br>同样使用的是 ConcurrentHashMap<br>参考资料中使用的是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; mStickyEventMap;</span><br></pre></td></tr></table></figure><p>那么同一个类只会有一个对象保留，后面发送的对象会把前面的对象覆盖掉。<br>而我希望一个新的对象不会覆盖老的对象，需要自己手动来删除。<br>所以这个地方改成</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;Class&lt;?&gt;,List&lt;Object&gt;&gt; map;</span><br></pre></td></tr></table></figure><p>Sticky 事件和普通事件使用的是同一个 Bus,所以接收者接收的是同一个对象时，当他们都订阅了事件时是没有区别的。</p><h3 id="发送-Sticky-事件"><a href="#发送-Sticky-事件" class="headerlink" title="发送 Sticky 事件"></a>发送 Sticky 事件</h3><p>这个其实就是在发送普通时间之前把这个事件写入到刚刚的 map 中去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSticky</span><span class="params">(Object object)</span></span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mStickyEventMap)&#123;</span><br><span class="line">        List list = mStickyEventMap.get(object.getClass());</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">            list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">       &#125;</span><br><span class="line">        list.add(object);</span><br><span class="line">        mStickyEventMap.put(object.getClass(),list);</span><br><span class="line">    &#125;</span><br><span class="line">    post(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="接收-Sticky-事件"><a href="#接收-Sticky-事件" class="headerlink" title="接收 Sticky 事件"></a>接收 Sticky 事件</h3><p>这个就是先查看 map 中是否有这个事件，有的话使用.merginWith 一起发出来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">toObservableSticky</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; eventType)</span></span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mStickyEventMap)&#123;</span><br><span class="line">        Observable&lt;T&gt; observable = bus.ofType(eventType);</span><br><span class="line">        <span class="keyword">final</span> List list =  mStickyEventMap.get(eventType);</span><br><span class="line">        <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; !list.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> observable.mergeWith(Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;T&gt;()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">for</span> (Object obj :list) &#123;</span><br><span class="line">                      subscriber.onNext(eventType.cast(obj));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> observable;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>还写了一些常用方法，例如 post 一个事件的时候覆盖同类事件，接收事件时消耗掉事件，代码在简书上写起来还是有点麻烦，详情看 GitHub，地址：<a href="https://github.com/relengxing/RxBus">https://github.com/relengxing/RxBus</a><br>要使用的时候把 RxBus 文件直接复制到工程即可。<br>如果有 BUG 可以在评论区告诉我。</p><p><img src="http://upload-images.jianshu.io/upload_images/2188564-c8fdc8129972449b.gif?imageMogr2/auto-orient/strip" alt="动画图"></p>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>rxjava</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
